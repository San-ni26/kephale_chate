generator client {
  provider = "prisma-client-js"
  output   = "../src/prisma/client"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                      String               @id @default(cuid())
  email                   String               @unique
  name                    String?
  avatarUrl               String?              @db.Text
  password                String
  phone                   String?
  publicKey               String               @db.Text
  encryptedPrivateKey     String               @db.Text
  otpCode                 String?
  otpExpiry               DateTime?
  isVerified              Boolean              @default(false)
  deviceId                String?
  deviceInfo              Json?
  location                Json?
  allowedCountry          String?
  isBanned                Boolean              @default(false)
  isFirstLogin            Boolean              @default(true)
  currentLocation         Json?
  lastSeen                DateTime?
  isOnline                Boolean              @default(false)
  role                    UserRole             @default(USER)
  canPublishNotifications Boolean              @default(false)
  createdAt               DateTime             @default(now())
  updatedAt               DateTime             @updatedAt
  publishedAnnouncements  Announcement[]
  deptMemberships         DepartmentMember[]
  groupMemberships        GroupMember[]
  sentMessages            Message[]
  notifications           Notification[]
  orgMemberships          OrganizationMember[]
  userPage                UserPage?
  likes                   Like[]
  comments                Comment[]
  postReads               PostRead[]
  assignedTasks           Task[]               @relation("TaskAssignee")
  createdTasks            Task[]               @relation("TaskCreator")
  headedDepartments       Department[]         @relation("DepartmentHead")
  taskMessages            TaskMessage[]
  departmentMonthlyReports DepartmentMonthlyReport[]
  pushSubscriptions       PushSubscription[]
  invitations             UserInvitation[]
  personalTasks           UserPersonalTask[]
  financialGoals          UserFinancialGoal[]
  financialProfile        UserFinancialProfile?
  monthlyStatements       UserMonthlyStatement[]
  financialEntries        UserFinancialEntry[]

  followers Follow[] @relation("UserFollowers")
  following Follow[] @relation("UserFollowing")

  @@index([email])
  @@index([isOnline])
  @@index([allowedCountry])
}

model UserInvitation {
  id     String           @id @default(cuid())
  userId String
  token  String           @unique
  status InvitationStatus @default(ACTIVE)

  // New fields
  title       String
  description String?        @db.Text
  imageBase64 String?        @db.Text
  type        InvitationType @default(OTHER)
  date        DateTime
  location    String
  maxGuests   Int?

  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  guests    InvitationGuest[]

  @@index([userId])
  @@index([token])
}

model InvitationGuest {
  id           String         @id @default(cuid())
  invitationId String
  name         String
  phone        String
  confirmedAt  DateTime       @default(now())
  invitation   UserInvitation @relation(fields: [invitationId], references: [id], onDelete: Cascade)

  @@index([invitationId])
}

enum InvitationStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

enum InvitationType {
  WEDDING
  DINNER
  BIRTHDAY
  PARTY
  OTHER
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())
  follower    User     @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Organization {
  id           String               @id @default(cuid())
  name         String
  code         String               @unique
  logo         String?              @db.Text
  address      String?              @db.Text
  isSuspended  Boolean              @default(false)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  ownerId      String
  departments  Department[]
  members      OrganizationMember[]
  subscription Subscription?
  events       EventInvitation[]

  @@index([code])
  @@index([isSuspended])
}

model OrganizationMember {
  id           String       @id @default(cuid())
  userId       String
  orgId        String
  role         OrgRole      @default(MEMBER)
  joinedAt     DateTime     @default(now())
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade, map: "OrganizationMember_orgId_fk")
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, orgId])
  @@index([orgId], map: "OrganizationMember_orgId_idx")
}

model Department {
  id                String                    @id @default(cuid())
  name              String
  orgId             String
  publicKey         String                    @db.Text
  headId            String?                   // Chef du département (peut attribuer des tâches)
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  organization      Organization             @relation(fields: [orgId], references: [id], onDelete: Cascade, map: "Department_orgId_fk")
  head              User?                     @relation("DepartmentHead", fields: [headId], references: [id], onDelete: SetNull)
  members           DepartmentMember[]
  conversations     Group[]
  tasks             Task[]
  eventBroadcasts   EventDepartmentBroadcast[]
  monthlyReports    DepartmentMonthlyReport[]

  @@index([orgId], map: "Department_orgId_idx")
  @@index([headId])
}

model DepartmentMember {
  id               String     @id @default(cuid())
  deptId           String
  userId           String
  encryptedDeptKey String     @db.Text
  department       Department @relation(fields: [deptId], references: [id], onDelete: Cascade)
  user             User       @relation(fields: [userId], references: [id], onDelete: Cascade, map: "DepartmentMember_userId_fk")

  @@unique([deptId, userId])
  @@index([userId], map: "DepartmentMember_userId_idx")
}

model Group {
  id         String        @id @default(cuid())
  name       String?
  isDirect   Boolean       @default(false)
  deptId     String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  department Department?   @relation(fields: [deptId], references: [id], map: "Group_deptId_fk")
  members    GroupMember[]
  messages   Message[]

  @@index([deptId], map: "Group_deptId_idx")
}

model GroupMember {
  id         String   @id @default(cuid())
  groupId    String
  userId     String
  joinedAt   DateTime @default(now())
  lastReadAt DateTime @default(now())
  group      Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade, map: "GroupMember_userId_fk")

  @@unique([groupId, userId])
  @@index([userId], map: "GroupMember_userId_idx")
}

model Message {
  id          String       @id @default(cuid())
  content     String       @db.Text
  senderId    String
  groupId     String
  isEdited    Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  attachments Attachment[]
  group       Group        @relation(fields: [groupId], references: [id], onDelete: Cascade)
  sender      User         @relation(fields: [senderId], references: [id])

  @@index([groupId, createdAt])
  @@index([senderId])
}

model Attachment {
  id        String   @id @default(cuid())
  messageId String
  type      FileType
  filename  String
  data      String   @db.Text
  createdAt DateTime @default(now())
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
}

model Notification {
  id        String    @id @default(cuid())
  content   String
  userId    String?
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  isRead    Boolean   @default(false)
  user      User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Announcement {
  id          String             @id @default(cuid())
  title       String
  content     String             @db.Text
  publisherId String
  expiresAt   DateTime
  createdAt   DateTime           @default(now())
  isActive    Boolean            @default(true)
  publisher   User               @relation(fields: [publisherId], references: [id], onDelete: Cascade)
  reads       AnnouncementRead[]

  @@index([expiresAt])
  @@index([isActive])
  @@index([publisherId], map: "Announcement_publisherId_idx")
}

model AnnouncementRead {
  id             String       @id @default(cuid())
  announcementId String
  userId         String
  readAt         DateTime     @default(now())
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)

  @@unique([announcementId, userId])
  @@index([userId])
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

enum FileType {
  IMAGE
  PDF
  WORD
  AUDIO
  OTHER
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum SubscriptionPlan {
  FREE
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

enum EventType {
  PROFESSIONAL
  DINNER
  MEETING
  PARTY
  CONFERENCE
  WORKSHOP
  OTHER
}

model OrganizationRequest {
  id         String        @id @default(cuid())
  userId     String
  cardCode   String
  status     RequestStatus @default(PENDING)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  reviewedBy String?
  reviewedAt DateTime?
  orgId      String?       @unique

  @@index([userId])
  @@index([status])
}

model PendingSubscriptionPayment {
  id            String   @id @default(cuid())
  transactionId String   @unique
  userId        String
  plan          String
  name          String
  logo          String?  @db.Text
  address       String?  @db.Text
  requestId     String?
  createdAt     DateTime @default(now())

  @@index([transactionId])
  @@index([userId])
}

model Subscription {
  id                String           @id @default(cuid())
  orgId             String           @unique
  plan              SubscriptionPlan @default(FREE)
  startDate         DateTime         @default(now())
  endDate           DateTime?
  maxDepartments    Int              @default(2)
  maxMembersPerDept Int              @default(5)
  isActive          Boolean          @default(true)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  organization      Organization     @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([isActive])
}

model EventInvitation {
  id                  String                     @id @default(cuid())
  orgId               String
  title               String
  description         String?                    @db.Text
  eventType           EventType                  @default(OTHER)
  eventDate           DateTime
  maxAttendees        Int
  imageUrl            String?                    @db.Text
  token               String                     @unique
  createdBy           String
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  organization        Organization              @relation(fields: [orgId], references: [id], onDelete: Cascade)
  rsvps               InvitationRSVP[]
  departmentBroadcasts EventDepartmentBroadcast[]

  @@index([orgId])
  @@index([token])
  @@index([eventDate])
}

model EventDepartmentBroadcast {
  id         String           @id @default(cuid())
  eventId    String
  deptId     String
  createdAt  DateTime         @default(now())
  event      EventInvitation  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  department Department      @relation(fields: [deptId], references: [id], onDelete: Cascade)

  @@unique([eventId, deptId])
  @@index([deptId])
  @@index([eventId])
}

model InvitationRSVP {
  id        String          @id @default(cuid())
  eventId   String
  name      String
  phone     String
  createdAt DateTime        @default(now())
  event     EventInvitation @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
}

model UserPage {
  id        String   @id @default(cuid())
  userId    String   @unique
  handle    String   @unique
  bio       String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  posts     Post[]

  @@index([handle])
}

enum PostType {
  TWEET
  CONTENT
}

model Post {
  id        String    @id @default(cuid())
  pageId    String
  type      PostType
  content   String    @db.Text
  imageUrl  String?   @db.Text
  caption   String?   @db.Text
  reference String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  page      UserPage  @relation(fields: [pageId], references: [id], onDelete: Cascade)
  likes     Like[]
  comments  Comment[]
  postReads PostRead[]

  @@index([pageId])
  @@index([createdAt])
}

model Like {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
}

model Comment {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  parentId String?
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("CommentReplies")

  @@index([postId])
  @@index([parentId])
}

model PostRead {
  id     String @id @default(cuid())
  userId String
  postId String
  readAt DateTime @default(now())
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post   Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Task {
  id          String       @id @default(cuid())
  title       String
  description String?      @db.Text
  status      TaskStatus   @default(PENDING)
  priority    TaskPriority @default(MEDIUM)

  startDate   DateTime?
  dueDate     DateTime?
  completedAt DateTime?

  deptId     String
  creatorId  String
  assigneeId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  department Department @relation(fields: [deptId], references: [id], onDelete: Cascade)
  creator    User       @relation("TaskCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  assignee   User       @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: Cascade)

  messages    TaskMessage[]
  attachments TaskAttachment[]

  @@index([deptId])
  @@index([assigneeId])
  @@index([creatorId])
  @@index([status])
}

model TaskMessage {
  id        String   @id @default(cuid())
  taskId    String
  senderId  String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  task   Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  sender User @relation(fields: [senderId], references: [id], onDelete: Cascade)

  attachments TaskAttachment[]

  @@index([taskId])
  @@index([senderId])
}

model TaskAttachment {
  id         String  @id @default(cuid())
  taskId     String
  messageId  String?
  uploaderId String // Optional: track who uploaded if not tied to message directly, though usually tied to message or task

  filename String
  url      String  @db.Text
  fileType String?
  size     Int?

  createdAt DateTime @default(now())

  task    Task         @relation(fields: [taskId], references: [id], onDelete: Cascade)
  message TaskMessage? @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([messageId])
}

// Rapport mensuel d'un membre du département (un par user/département/mois)
model DepartmentMonthlyReport {
  id        String   @id @default(cuid())
  deptId    String
  userId    String
  month     String   // "yyyy-MM" (ex: "2025-02")
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  department Department @relation(fields: [deptId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([deptId, userId, month])
  @@index([deptId])
  @@index([userId])
  @@index([month])
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String   @unique @db.Text
  p256dh    String   @db.Text
  auth      String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// === Tâches personnelles et finances utilisateur ===

enum PersonalTaskStatus {
  TODO
  IN_PROGRESS
  DONE
  CANCELLED
}

enum PersonalTaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model UserPersonalTask {
  id          String              @id @default(cuid())
  userId      String
  title       String
  description String?             @db.Text
  status      PersonalTaskStatus  @default(TODO)
  priority    PersonalTaskPriority @default(MEDIUM)
  dueDate     DateTime?
  completedAt DateTime?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([dueDate])
}

enum FinancialGoalType {
  ANNUAL_SAVINGS    // Épargne annuelle
  MATERIAL_PURCHASE  // Achat d'un bien matériel (voiture, téléphone, etc.)
}

model UserFinancialGoal {
  id              String             @id @default(cuid())
  userId          String
  type            FinancialGoalType   @default(ANNUAL_SAVINGS)
  year            Int?                // Pour ANNUAL_SAVINGS
  targetItem      String?             @db.Text // Pour MATERIAL_PURCHASE: "Voiture", "Téléphone"
  targetAmount    Float
  targetDate      DateTime?           // Pour MATERIAL_PURCHASE: date souhaitée d'achat
  label           String?             @db.Text
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  user      User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  progress  UserMonthlyProgress[]

  @@index([userId])
  @@index([type])
}

model UserFinancialProfile {
  id                    String   @id @default(cuid())
  userId                String   @unique
  monthlySalary         Float    @default(0)
  supplementaryIncome  Float    @default(0)
  currency              String   @default("FCFA")
  preferredSavingsRate  Float?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserMonthlyStatement {
  id                  String   @id @default(cuid())
  userId              String
  year                Int
  month               Int
  salaryReceived      Float    @default(0)
  supplementaryIncome Float    @default(0)
  totalExpenses       Float    @default(0)
  notes               String?  @db.Text
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year, month])
  @@index([userId])
  @@index([year, month])
}

// Entrées financières détaillées : salaire, revenus supplémentaires, dépenses
// Chaque entrée a une note et peut être confirmée pour le calcul du graphique
enum FinancialEntryType {
  SALARY              // Salaire reçu
  SUPPLEMENTARY_INCOME // Revenu supplémentaire (freelance, bonus...)
  EXPENSE             // Dépense
}

model UserFinancialEntry {
  id          String            @id @default(cuid())
  userId      String
  year        Int
  month       Int
  type        FinancialEntryType
  amount      Float
  note        String?           @db.Text
  isConfirmed Boolean           @default(false)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, year, month])
  @@index([type])
}

model UserMonthlyProgress {
  id          String   @id @default(cuid())
  goalId      String
  year        Int
  month       Int      // 1-12
  amount      Float    @default(0) // Montant atteint ce mois (FCFA)
  notes       String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  goal UserFinancialGoal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@unique([goalId, year, month])
  @@index([goalId])
  @@index([year, month])
}
